<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: networking | Random Notes]]></title>
  <link href="http://devrandom.za.net/blog/categories/networking/atom.xml" rel="self"/>
  <link href="http://devrandom.za.net/"/>
  <updated>2015-02-09T12:07:38+02:00</updated>
  <id>http://devrandom.za.net/</id>
  <author>
    <name><![CDATA[S.J. Louw]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[QoS (Quality of Service) - part1]]></title>
    <link href="http://devrandom.za.net/blog/2015/01/05/qos-quality-of-service-part1/"/>
    <updated>2015-01-05T09:29:42+02:00</updated>
    <id>http://devrandom.za.net/blog/2015/01/05/qos-quality-of-service-part1</id>
    <content type="html"><![CDATA[<p><img class="left" src="/images/blog_posts/qos.png"></p>

<p>This is part 1 of 2. My shortish summarized version of Quality of Service (QoS), Basic concepts, Marking and Congestion Management.</p>

<!--more-->


<br>


<br>


<br>


<h3>Quality Of Service (QoS) Basics:</h3>

<p><strong>Main Traffic-type Characteristics:</strong></p>

<ul>
<li><strong>Voice</strong> traffic flow is smooth in nature, subject to packet drops, delay and has predictable bandwidth usage.</li>
<li><strong>Video</strong> traffic is bursty and has greedy traffic usage.</li>
<li><strong>Data</strong> traffic varies per application.</li>
</ul>


<p><strong>Main Traffic Challenges:</strong></p>

<ul>
<li>Lack of bandwith</li>
<li>Packet loss</li>
<li>Delay</li>
<li>Jitter (Variation in delay)</li>
</ul>


<p><strong>Latency/Delay Types:</strong></p>

<ul>
<li><strong>Propagation delay:</strong> time taken for head of signal to travel from sender to receiver.</li>
<li><strong>Serialization delay:</strong> time needed to place data on the wire/medium.</li>
<li><strong>Processing delay:</strong> time spend to take from input interface and move to output interface.</li>
<li><strong>Packetization delay:</strong> time taken to turn data into packets.</li>
<li><strong>Queueing delay:</strong> time spend in the queues of output interface.</li>
</ul>


<h3>QoS Methods:</h3>

<ul>
<li><strong>Classification</strong> &ndash; identifying and groupiong different traffic types.</li>
<li><strong>Marking</strong> &ndash; tags/colors packets so it can be identified elsewhare in a network.</li>
<li><strong>Policing</strong> &ndash; drops or marks packets when specified limit is reached.</li>
<li><strong>Shaping</strong> &ndash; queues packets when a specified limit is reached.</li>
<li><strong>Congestion Avoidence</strong>

<ul>
<li>FIFO (First-in First-out) &ndash; Tail-drop</li>
<li>RED (Random Early Detection) &ndash; Drops packets randomly</li>
<li>WRED (Weighted Random Early Detection) &ndash; Drops packets with specified markings</li>
</ul>
</li>
<li><strong>Congestion Management</strong> &ndash; Ordering packets in most efficient way</li>
<li><strong>Link Efficiency</strong>

<ul>
<li>Compression</li>
<li>Link Fragmentation and Interleaving (LFI)</li>
</ul>
</li>
</ul>


<h3>Modular QoS CLI (MQC):</h3>

<ol>
<li>Configure <code>class-map</code></li>
<li>Configure <code>policy-map</code></li>
<li>Apply <code>service-policy</code> (ONLY 1 per interface per direction)</li>
</ol>


<br>


<p><img class="center" src="/images/blog_posts/qos_mqc.png"></p>

<h3>Classification:</h3>

<ul>
<li><strong>Inspecting</strong> one or more aspects of a packet to see what it&rsquo;s carrying.</li>
</ul>


<p><strong>Network Based Application Recognition (NBAR):</strong></p>

<ul>
<li>Deep packet inspection to identify traffic</li>
<li>OSI Layers 5 &ndash; 7</li>
<li>Identification &ldquo;signatures&rdquo; (PDLM files / PDLM packs) can be extended (<code>ip nbar pdlm flash://whatever.pdlm</code>)</li>
</ul>


<p><strong>Example:</strong></p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class-map MYMAP
</span><span class='line'>  match protocol &lt;SOME_PROTOCOL_NAME></span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p><strong>NBAR Stats Collection:</strong></p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>interface Gi0/0
</span><span class='line'>  ip nbar protocol-discovery
</span><span class='line'>  load-interval 60&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>show ip nbar protocol-discovery stats bit-rate top-n 10
</span><span class='line'>show ip nbar unclassified-port-stats (Unknown traffic)</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<h3>Marking:</h3>

<ul>
<li><strong>Writing</strong> information to a packet to identify the classification decision.</li>
<li>Mark packets as close to source (trust boundry) as possible.</li>
</ul>


<p><strong>Types Of Marking:</strong></p>

<ul>
<li><strong>Layer 2</strong> &ndash; Typically stripped at Layer 3 hops

<ul>
<li>example: COS, MPLS (Experimental bits), Frame Relay (DE bit), ATM (CLD bit)</li>
</ul>
</li>
<li><strong>Layer 3</strong> &ndash; Passes through Layer 3 hops, excluding NAT

<ul>
<li>example: IP Precedence, DSCP</li>
</ul>
</li>
</ul>


<p><strong>Example:</strong></p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class-map MATCH_HTTP
</span><span class='line'>  match protocol http&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>policy-map MARKING_HTTP
</span><span class='line'>  class MATCH_HTTP&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;pre>&lt;code>set ip precedence &lt;PRECEDENCE_VALUE&gt; (0 - 7)
</span><span class='line'>&lt;/code>&lt;/pre>
</span><span class='line'>
</span><span class='line'>&lt;p>interface Gi0/0
</span><span class='line'>  service-policy &lt;INPUT_OR_OUTPUT> MARKING_HTTP</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<h4>IP Precedence and DSCP:</h4>

<br>


<p><img class="center" src="/images/blog_posts/ipp_dscp_compat.png"></p>

<ul>
<li><strong>7</strong> &ndash; Network &ndash; Reserved</li>
<li><strong>6</strong> &ndash; Internet &ndash; Reserved</li>
<li><strong>5</strong> &ndash; Critical &ndash; Voice bearer (RTP)</li>
<li><strong>4</strong> &ndash; Flash Override &ndash; Video</li>
<li><strong>3</strong> &ndash; Flash &ndash; Voice signaling (RTCP) or Video</li>
<li><strong>2</strong> &ndash; Immediate &ndash; High priority data</li>
<li><strong>1</strong> &ndash; Priority &ndash; Medium priority data</li>
<li><strong>0</strong> &ndash; Routine &ndash; Best effort data</li>
</ul>


<p><img class="center" src="/images/blog_posts/ipp_dscp_compat_chart.png"></p>

<h3>Congestion Management:</h3>

<ul>
<li><strong>FIFO (First-in First-out):</strong>

<ul>
<li>Best effort</li>
<li>ONLY 1 queue (1 send and 1 receive)</li>
<li>method: FIFO</li>
<li>NO delay guarentee</li>
<li>NO bandwidth guarentee</li>
</ul>
</li>
<li><strong>Priority Queueing:</strong>

<ul>
<li>Can cause bandwith starvation for &ldquo;NOT high&rdquo; trafffic.</li>
<li>4 queues (High, Medium, Normal, Low)</li>
<li>method: strict priority</li>
<li>ONLY High priority delay guarentee</li>
<li>NO bandwidth guarentee</li>
</ul>
</li>
<li><strong>Custom Queueing:</strong>

<ul>
<li>Assigns bytes per protocol per queue.</li>
<li>16 queues</li>
<li>method: Round-robin</li>
<li>NO delay guarentee</li>
<li>Bandwidth GUARENTEE</li>
</ul>
</li>
<li><strong>Weighted Fair Queueing (WFQ):</strong>

<ul>
<li>Cisco default for links less than 2048 bit/s</li>
<li>Number of queues per flow</li>
<li>method: Weighted Fair (least top talker gets priority)</li>
<li>NO delay guarentee</li>
<li>NO bandwidth guarentee</li>
</ul>
</li>
<li><strong>Class-based Weighted Fair Queueing (CBWFQ):</strong>

<ul>
<li>Up to 256 classes (class-maps)</li>
<li>Use % of bandwidth per class-map</li>
<li>method: N/A</li>
<li>NO delay guarentee</li>
<li>Bandwidth GUARENTEE</li>
</ul>
</li>
<li><strong>Low Latency Queueing (LLQ):</strong>

<ul>
<li>1 Priority queue plus CBWFQ</li>
<li>method: Policed priority (Uses combination of other queueing methods)</li>
<li>Delay GUARENTEE for priority queue traffic</li>
<li>Bandwidth GUARENTEE</li>
</ul>
</li>
</ul>


<p><strong>Marking and LLQ Implementation:</strong></p>

<p><strong>NOTE:</strong> Will ONLY see effect when there is congestion!</p>

<br>


<p><img class="center" src="/images/blog_posts/congestion_management.png"></p>

<p><strong>Router 2 Configuration:</strong></p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class-map MATCH_HTTP
</span><span class='line'>  match protocol http&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>class-map MATCH_FTP
</span><span class='line'>  match protocol ftp&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>policy-map MARK_TRAFFIC
</span><span class='line'>  class MATCH_HTTP&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;pre>&lt;code>set dscp af21
</span><span class='line'>&lt;/code>&lt;/pre>
</span><span class='line'>
</span><span class='line'>&lt;p>  class MATCH_FTP&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;pre>&lt;code>set dscp af11
</span><span class='line'>&lt;/code>&lt;/pre>
</span><span class='line'>
</span><span class='line'>&lt;p>interface Gi0/1
</span><span class='line'>  service-policy output MARK_TRAFFIC&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>show class-map
</span><span class='line'>show policy-map
</span><span class='line'>show policy-map interface Gi0/1</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p><strong>Router 1 Configuration:</strong></p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class-map MATCH_AF11
</span><span class='line'>  match dscp af11&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>class-map MATCH_AF21
</span><span class='line'>  match dscp af21&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>policy-map LLQ
</span><span class='line'>  class MATCH_AF11&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;pre>&lt;code>bandwidth percent 15 (WFQ)
</span><span class='line'>&lt;/code>&lt;/pre>
</span><span class='line'>
</span><span class='line'>&lt;p>  class MATCH_AF21&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;pre>&lt;code>priority percent 15 (LLQ)
</span><span class='line'>&lt;/code>&lt;/pre>
</span><span class='line'>
</span><span class='line'>&lt;p>  class class-default&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;pre>&lt;code>fair-queue (CBWFQ)
</span><span class='line'>&lt;/code>&lt;/pre>
</span><span class='line'>
</span><span class='line'>&lt;p>interface Gi0/1
</span><span class='line'>  service-policy output LLQ&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>show class-map&lt;br/>
</span><span class='line'>show policy-map
</span><span class='line'>show policy-map interface Gi0/1</span></code></pre></td></tr></table></div></figure></notextile></div></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[QoS (Quality of Service) - part2]]></title>
    <link href="http://devrandom.za.net/blog/2015/01/05/qos-quality-of-service-part2/"/>
    <updated>2015-01-05T09:14:26+02:00</updated>
    <id>http://devrandom.za.net/blog/2015/01/05/qos-quality-of-service-part2</id>
    <content type="html"><![CDATA[<p><img class="left" src="/images/blog_posts/qos.png"></p>

<p>This is part 2 of 2. My shortish summarized version of Quality of Service (QoS), Congestion Avoidence, Policing and Shaping.</p>

<!--more-->


<br>


<br>


<br>


<h3>Congestion Avoidence with WRED:</h3>

<ul>
<li>ONLY TCP traffic</li>
<li><strong>TCP Global Synchronization</strong> happens to TCP flows during periods of congestion. Each sender will reduce their TX rate (at same time) &ndash; (Window-size to half) when packet loss occurs.</li>
<li>WRED designed to avoid numerous and sudden packet drops that can cause TCP Global Synchronization.</li>
<li>Randomly drops packets from TCP flows to minimize synchronization.</li>
<li>Dropping becomes more aggressive as queues fill up.</li>
</ul>


<p><img class="center" src="/images/blog_posts/wred.png"></p>

<p><strong>Example:</strong></p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class-map MATCH_HTTP
</span><span class='line'>  match protocol http&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>policy-map SET_HTTP
</span><span class='line'>  class MATCH_HTTP&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;pre>&lt;code>random-detect dscp af11 &lt;PACKETS_MIN&gt; &lt;PACKETS_MAX&gt; &lt;MPD_1-65535&gt;
</span><span class='line'>           or
</span><span class='line'>random-detect dscp-based (auto)
</span><span class='line'>&lt;/code>&lt;/pre>
</span><span class='line'>
</span><span class='line'>&lt;p>interface Gi0/0
</span><span class='line'>  service-policy &lt;INPUT_OR_OUTPUT> SET_HTTP&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>show class-map
</span><span class='line'>show policy-map
</span><span class='line'>show policy-map interface Gi0/0</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<h3>ECN (Explicit Congestion Notification):</h3>

<ul>
<li>WRED enhancement</li>
<li>Sender and receiver MUST support ECN</li>
<li>Instead of dropping packets, tells sender to slow down</li>
<li><strong>2x ECN bits:</strong>

<ul>
<li><strong>00</strong> = NOT ECN capable</li>
<li><strong>01</strong> = ECN capable</li>
<li><strong>10</strong> = ECN capable</li>
<li><strong>11</strong> = Congestion experienced</li>
</ul>
</li>
<li>When upstream router gets packet with <strong>11</strong> bit set, it returns <strong>ECN-echo</strong> packet to sender (application / host) and tells it to slow down.</li>
<li>Can be enabled under policy-map with <code>random-detect ecn</code>.</li>
</ul>


<h3>Compression:</h3>

<ul>
<li>Payload Compression</li>
<li>TCP Header Compression (suppress redundent header information)</li>
</ul>


<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class-map MATCH_HTTP
</span><span class='line'>  match protocol http&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>policy-map COMPRESS_HTTP
</span><span class='line'>  class MATCH_HTTP&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;pre>&lt;code>compression header ip ?
</span><span class='line'>&lt;/code>&lt;/pre>
</span><span class='line'>
</span><span class='line'>&lt;p>interface Gi0/0
</span><span class='line'>  service-policy &lt;INPUT_OR_OUTPUT> COMPRESS_HTTP&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>show class-map
</span><span class='line'>show policy-map
</span><span class='line'>show policy-map interface Gi0/0</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<h3>LFI (Link Fragmentation and Interleaving):</h3>

<ul>
<li>Cause higher bandwidth usage due to packets being fragmented and every fragment needs it&rsquo;s own header.</li>
<li>Used to reduce serialization delay</li>
<li>NOT used on links faster than 768 Kbps</li>
<li>ONLY used on Frame-relay and PPP</li>
</ul>


<h3>Traffic Policing:</h3>

<ul>
<li><strong>Drops</strong> or <strong>marks</strong> traffic exceeding specified thresholds</li>
<li>Use &ldquo;Token Bucket&rdquo; concept</li>
</ul>


<p><strong>Single Token Bucket:</strong></p>

<p><img class="center" src="/images/blog_posts/single_token_bucket.png"></p>

<p><strong>Example:</strong></p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class-map match-any MATCH_PROTOCOLS
</span><span class='line'>  match protocol edonkey
</span><span class='line'>  match protocol napster&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>policy-map POLICE_PROTOCOLS
</span><span class='line'>  class MATCH_PROTOCOLS&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;pre>&lt;code>police &lt;BPS_RATE&gt; conform-action transmit exceed-action drop
</span><span class='line'>&lt;/code>&lt;/pre>
</span><span class='line'>
</span><span class='line'>&lt;p>interface Gi0/0
</span><span class='line'>  service-policy input POLICE_PROTOCOLS&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>show class-map
</span><span class='line'>show policy-map
</span><span class='line'>show policy-map interface Gi0/0</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p><strong>Dual Token Bucket:</strong></p>

<p><img class="center" src="/images/blog_posts/dual_token_buckets.png"></p>

<p><strong>Example:</strong></p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class-map match-any MATCH_PROTOCOLS
</span><span class='line'>  match protocol edonkey
</span><span class='line'>  match protocol napster&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>policy-map POLICE_PROTOCOLS
</span><span class='line'>  class MATCH_PROTOCOLS&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;pre>&lt;code>police &lt;BPS_RATE&gt; &lt;BURST_RATE&gt; &lt;PEAK_BURST&gt; conform-action transmit exceed-action set-dscp-transmit &lt;AF23&gt; violate-action drop
</span><span class='line'>&lt;/code>&lt;/pre>
</span><span class='line'>
</span><span class='line'>&lt;p>interface Gi0/0
</span><span class='line'>  service-policy input POLICE_PROTOCOLS&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>show class-map
</span><span class='line'>show policy-map
</span><span class='line'>show policy-map interface Gi0/0</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<h3>Traffic Shaping:</h3>

<ul>
<li><strong>Shapes</strong> per class and NOT per interface</li>
<li><strong>Queues</strong> excess traffic and send at desired rate (class-based)</li>
<li>Cannot mark traffic with shaping</li>
<li>Can shape per average or peak rate</li>
<li>BECN (Backwards Explicit Congestion Notification)</li>
<li>FECN (Forward Explicit Congestion Notification)</li>
</ul>


<p><img class="center" src="/images/blog_posts/shaping.png"></p>

<p><strong>Example Shaping:</strong></p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class-map match-any MATCH_PROTOCOLS
</span><span class='line'>  match protocol edonkey
</span><span class='line'>  match protocol napster&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>policy-map SHAPE_PROTOCOLS
</span><span class='line'>  class MATCH_PROTOCOLS&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;pre>&lt;code>shape peak &lt;BPS&gt; (CIR)
</span><span class='line'>         or
</span><span class='line'>shape average &lt;BPS&gt; (CIR)
</span><span class='line'>&lt;/code>&lt;/pre>
</span><span class='line'>
</span><span class='line'>&lt;p>interface Gi0/0
</span><span class='line'>  service-policy input SHAPE_PROTOCOLS&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>show class-map
</span><span class='line'>show policy-map
</span><span class='line'>show policy-map interface Gi0/0</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p><strong>Example Queueing (Nested policy and class-maps):</strong></p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>policy-map PRIORITY
</span><span class='line'>  class DATA&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;pre>&lt;code>bandwidth 50
</span><span class='line'>&lt;/code>&lt;/pre>
</span><span class='line'>
</span><span class='line'>&lt;p>  class class-default&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;pre>&lt;code>fair-queue
</span><span class='line'>&lt;/code>&lt;/pre>
</span><span class='line'>
</span><span class='line'>&lt;p>class-map ALL_TRAFFIC
</span><span class='line'>  match class DATA
</span><span class='line'>  match class class-default&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>policy-map SHAPE_IT
</span><span class='line'>  class ALL_TRAFFIC&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;pre>&lt;code>shape average 500000
</span><span class='line'>service-policy PRIORITY
</span><span class='line'>&lt;/code>&lt;/pre>
</span><span class='line'>
</span><span class='line'>&lt;p>interface Gi0/0
</span><span class='line'>  service-policy input SHAPE_IT&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>show class-map
</span><span class='line'>show policy-map
</span><span class='line'>show policy-map interface Gi0/0</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<h3>Catalyst QoS (Class Of Service (COS)):</h3>

<ul>
<li>Layer 2</li>
<li>Classification, marking, policing, etc. done in hardware ASICs (CEF)</li>
<li>Switch QoS capabilities defined in terms of:

<ul>
<li>Queues (priority / standard)</li>
<li>Thresholds (ammount of packets possibly held in queue)</li>
</ul>
</li>
<li><strong>Queues can be configured as:</strong>

<ul>
<li>Priority Queues</li>
<li>Weighted Round-robin (WRR) &ndash; Custom queue</li>
<li>Weighted Round-robin (WRR) &ndash; Priority queue</li>
</ul>
</li>
<li><strong>Thresholds can be configured with:</strong>

<ul>
<li>Tail drop</li>
<li>WRED</li>
</ul>
</li>
<li>Also uses class-maps and policy-maps</li>
<li>IP phones normaly tags voice packets &ndash; can be &ldquo;caught&rdquo; by switch and manipulated.</li>
<li>Supports TX queues (RX queues ONLY on high end switches)</li>
</ul>


<p><strong>Example switch QoS support tags:</strong></p>

<ul>
<li><strong>2Q2T</strong> = 2x Queue, 2x Thresholds per Queue</li>
<li><strong>1P2Q2T</strong> = 1x Priority Queue, 2x Standard Queues, 2x Thresholds per Queue</li>
</ul>


<p><strong>Example:</strong></p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>mls qos (turn it on)&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>interface Gi0/0
</span><span class='line'>  mls qos trust (trust markings received on port)
</span><span class='line'>  wrr-queue cos-map 1 0 1 2  &mdash;&ndash;|
</span><span class='line'>  wrr-queue cos-map 2 3 4       |> first row, 1 &ndash; 4 = queue number
</span><span class='line'>  wrr-queue cos-map 3 6 7       |> the rest, IP Precedence values 0 &ndash; 7
</span><span class='line'>  wrr-queue cos-map 4 5      &mdash;&ndash;|
</span><span class='line'>  wrr-queue bandwidth &lt;WEIGHT_1-65536> 5 6 10 1
</span><span class='line'>  priority-queue out</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<ul>
<li>5 = queue1, 6 = queue2, 10 = queue3, 1 = queue 4 (Last queue becomes priority queue)</li>
<li>5 + 6 + 10 + 1 = 22</li>
<li>Queue1 = 5 / 22 * 100 = 22.73% of total bandwidth</li>
<li>Queue2 = 6 / 22 * 100 = 27.27% of total bandwidth</li>
<li>Queue3 = 10 / 22 * 100 = 45.45% of total bandwidth</li>
<li>Queue4 = 1 / 22 * 100 = 4.55% of total bandwidth</li>
</ul>


<h3>Auto-QoS:</h3>

<ul>
<li><strong>cef</strong> MUST be anabled (<code>ip cef</code>)</li>
<li><strong>bandwidth</strong> MUST be configured on interface (<code>bandwidth &lt;BPS&gt;</code>)</li>
<li><strong>IP address</strong> MUST be assigned</li>
</ul>


<p><strong>Example:</strong></p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>interface Gi0/0
</span><span class='line'>  bandwidth &lt;BPS>
</span><span class='line'>  auto qos &lt;   > ?&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>show class-map
</span><span class='line'>show policy-map
</span><span class='line'>show ip access-list
</span><span class='line'>show running-config</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<h3>PAK Priority:</h3>

<ul>
<li>Router auto-tags all &ldquo;mission-critical&rdquo; (control-plane) traffic with IPP6/CS6</li>
<li>Is an un-changeable internal mechanism</li>
</ul>


<h3>TX-Ring:</h3>

<ul>
<li>Hardware queue of a router</li>
<li>Automatically tuned by later Cisco IOS versions</li>
<li>Typically holds 32 &ndash; 64 packets by default</li>
<li>Reduce to 3 on slow, smaller then 1.5Mbit/s links</li>
<li><code>show controllers &lt;INTERFACE&gt; | incl tx_limited</code></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[MPLS Layer 3 VPN Basics, Setup and Verification - part1]]></title>
    <link href="http://devrandom.za.net/blog/2014/12/22/mpls-layer-3-vpn-basics-setup-and-verification/"/>
    <updated>2014-12-22T22:59:29+02:00</updated>
    <id>http://devrandom.za.net/blog/2014/12/22/mpls-layer-3-vpn-basics-setup-and-verification</id>
    <content type="html"><![CDATA[<p><img class="left" src="/images/blog_posts/mpls.png"></p>

<p>This is part 1 of 2. My shortish summarized version of MPLS Layer 3 VPN Basics, Setup and Verification.</p>

<!--more-->


<br>


<br>


<br>


<br>


<br>


<p><iframe width="640" height="360" src="http://www.youtube.com/embed/MEWIdO40U54 " frameborder="0" allowfullscreen></iframe></p>

<h3>MPLS Layer 3 VPNs:</h3>

<ul>
<li>Private routing (site-2-site) per customer (VRF)</li>
<li>Virtual Network (private) VPN &ndash; Separates data-plane, securely (NO encryption), per customer.</li>
<li>Terminology:

<ul>
<li>Label Switched Path (<strong>LSP</strong>)</li>
<li>Label Switch Router (<strong>LSR</strong>)</li>
<li>Customer Edge (<strong>CE</strong>)</li>
<li>Provider Edge (<strong>PE</strong>)</li>
<li>Provider (<strong>P</strong>)</li>
<li>Routing Information Base (<strong>RIB</strong>)</li>
<li>Forwarding Information Base (<strong>FIB</strong>)</li>
<li>Label Information Base (<strong>LIB</strong>)</li>
<li>Label Forwarding Information Base (<strong>LFIB</strong>)</li>
</ul>
</li>
<li>General label flow procedure:

<ul>
<li>CE &mdash;&mdash;&mdash;&mdash;&mdash;&mdash;> PE = <strong>PUSH</strong> label (entering core)</li>
<li>PE &mdash;&mdash;&mdash;&mdash;&mdash;&mdash;> PE = <strong>SWOP</strong> labels (inside core)</li>
<li>PE &mdash;&mdash;&mdash;&mdash;&mdash;&mdash;> CE = <strong>POP</strong> label (exiting core)</li>
</ul>
</li>
<li>MPLSs' control-plane protocol is Label Distribution Protocol <strong>(LDP)</strong></li>
<li>Experimental bits inside packet = Used for QoS</li>
<li>Bottom-of-stack bits (S-bit) inside packet &ndash; If = 1 indicates bottom of stack has been reached</li>
<li>MPLS header injected between Data-link (Layer2) and Network layer (Layer3)</li>
</ul>


<h3>Basic Setup Procedure:</h3>

<ol>
<li>Before setting up MPLS, first verify basic IP routing/reachability.</li>
<li>Setup MPLS only on PE to PE routers.</li>
<li><code>mpls label range 100 199</code> (Setup label range for router to use)</li>
<li><code>mpls ip</code> (Enable MPLS in Global Config mode)</li>
<li><code>mpls ip</code> (Enable MPLS under interfaces to be used)</li>
</ol>


<p>When MPLS is enabled globally, it creates local labels for each route in it&rsquo;s routing table. (default does <strong>NOT</strong> stay static, can change) Then when MPLS is enabled on interfaces, <strong>LDP</strong> forms neighbors and exchange labels.</p>

<h3>Verifying Labels:</h3>

<ol>
<li><code>show mpls ldp bindings x.x.x.x &lt;SLASH_NOTATION_MASK&gt;</code></li>
<li><code>show mpls forwarding-table x.x.x.x</code> (Forwarding table is build from <strong>RIB</strong>)</li>
</ol>


<p><strong>NOTES:</strong></p>

<ul>
<li>Label, implicit Null (<strong>imp-null</strong>) (3) &ndash; Directly attached networks</li>
<li>MPLS reserved labels = 0-15</li>
<li>By default LAST <strong>P</strong> router POPs label before sending to LAST <strong>PE</strong> router. (Penultimate Hop Popping &ndash; PHP)</li>
<li>If MPLS enabled : <code>traceroute</code> will include MPLS label</li>
</ul>


<h3>Label Distribution Protocol (LDP):</h3>

<ul>
<li>Labels does <strong>NOT</strong> stay statically numbered by default. It <strong>WILL</strong> change when router reboots, config changes, etc.</li>
<li>Best path will ALWAYS be LSP over IPv4</li>
<li>IPv4 <strong>transport address</strong> (can be changed) used to form neighbors, NOT necessarily = Router-ID.</li>
<li>Router MUST be able to reach neighbor&rsquo;s <strong>transport address</strong> to establish neighbor relationship.</li>
<li>Use multicast <strong>224.0.0.2</strong>, destination <strong>UDP port 646</strong> in Hello packets.</li>
<li>Use unicast, <strong>TCP port 646</strong> to establish neighbor relationship.</li>
<li>Highest Router-ID will be <strong>Active / initiating</strong> router and lower Router-ID will be <strong>Passive / receiving</strong> router in TCP LDP neighbor negotiation.</li>
</ul>


<p>Show labels assigned to routes:</p>

<p><code>show mpls ldp bindings</code></p>

<p>Show local labels ONLY:</p>

<p><code>show mpls ldp bindings local</code></p>

<p>Show label best path for a route:</p>

<p><code>show mpls forwarding-table x.x.x.x</code></p>

<p>Debug LDP bindings:</p>

<p><code>debug mpls ldp bindings</code></p>

<p><strong>LDP Router-ID selection, order of preference:</strong></p>

<ol>
<li>Administratively configured address (<code>mpls ldp router-id &lt;INTERFACE/NUM&gt; force (global config mode)</code>)</li>
<li>Highest IP address on loopback</li>
<li>Highest IP address on interface</li>
</ol>


<p><strong>Transport address selection, order of preference:</strong></p>

<ol>
<li>Administratively configured address (<code>mpls ldp discovery transport-address interface (under interface)</code>)</li>
<li>Router-ID</li>
</ol>


<p><strong>Verifying both Router-ID and transport address:</strong></p>

<p><code>show mpls ldp discovery detail</code></p>

<h3>Label Switched Path (LSP):</h3>

<p><strong>Label Retention:</strong></p>

<ul>
<li><strong>Liberal Label Retention (LLR) (default):</strong> Label mapping received from peer is retained regardless of whether the LSR is the next hop for advertised mapping.</li>
<li><strong>Conservative Label retention (CLR):</strong> Label mappings will ONLY be retained if sending LSR is next hop downstream router for this specific FEC. ONLY labels used for MPLS packet forwarding are kept in LIB.</li>
</ul>


<p><strong>Verification:</strong></p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>show mpls ldp neighbor
</span><span class='line'>show mpls ldp bindings x.x.x.x
</span><span class='line'>show mpls forwarding-table x.x.x.x
</span><span class='line'>traceroute x.x.x.x</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<h3>Multi-protocol BGP (mBGP):</h3>

<ul>
<li>Configured on PE routers</li>
<li>VPNv4 routes include VRF/Route distinguishing (RD) info</li>
<li><strong>Route targets</strong> included inside VPNv4 routes as extended community values, to be imported into VRFs on PE routers.</li>
</ul>


<p><strong>Configuration:</strong></p>

<p><strong>1. Verify</strong> PE to PE connectivity (<code>ping</code> / <code>traceroute</code>)</p>

<p><strong>2. Setup:</strong>
<div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>router bgp 100
</span><span class='line'>  neighbor x.x.x.x remote-as 100 (iBGP)
</span><span class='line'>  neighbor x.x.x.x update-source loopback 0
</span><span class='line'>  address-family vpnv4&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;pre>&lt;code>neighbor x.x.x.x activate
</span><span class='line'>neighbor x.x.x.x send-community extended
</span><span class='line'>&lt;/code>&lt;/pre>
</span><span class='line'>
</span><span class='line'>&lt;p></span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p><strong>3. Verify:</strong>
<div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>show ip bgp neighbors | section capabilities
</span><span class='line'>show control-plane host open-ports</span></code></pre></td></tr></table></div></figure></notextile></div></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[MPLS Layer 3 VPN VRFs and Redistribution - part2]]></title>
    <link href="http://devrandom.za.net/blog/2014/12/21/mpls-layer-3-vpn-vrfs-and-redistribution/"/>
    <updated>2014-12-21T14:16:06+02:00</updated>
    <id>http://devrandom.za.net/blog/2014/12/21/mpls-layer-3-vpn-vrfs-and-redistribution</id>
    <content type="html"><![CDATA[<p><img class="left" src="/images/blog_posts/mpls.png"></p>

<p>This is part 2 of 2. My shortish summarized version of MPLS Layer 3 VPN VRFs and Redistribution.</p>

<!--more-->


<br>


<br>


<br>


<br>


<h3>Virtual Routing and Forwarding (VRF) Instances:</h3>

<ul>
<li><strong>VRF Name:</strong> AS:THECOMPANY</li>
<li><strong>Route Distinguisher:</strong> AS:NUMBER or IP_ADDRESS:NUMBER (Does NOT have to match PE-PE)</li>
<li><strong>Route Target (extended community):</strong> IP_ADDRESS:NUMBER or AS:NUMBER (Export and Import MUST match PE-PE)</li>
<li><strong>Interface</strong> towards CE to be allocated to VRF</li>
</ul>


<p>NOTES:</p>

<p>In production, disable TTL propagation (on <strong>ALL</strong> MPLS routers) to hide label info inside traceroute! (<code>no mpls ip propagate-ttl</code>)</p>

<p><strong>Configuration (On PE routers):</strong></p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>vrf definition 100:THECOMPANY
</span><span class='line'>  rd 100:1
</span><span class='line'>  address-family ipv4&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;pre>&lt;code>route-target export x.x.x.x:100 (reversed on other PE router)
</span><span class='line'>route-target import y.y.y.y:100 (reversed on other PE router)
</span><span class='line'>exit
</span><span class='line'>&lt;/code>&lt;/pre>
</span><span class='line'>
</span><span class='line'>&lt;p>  exit&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>interface Gi0/1
</span><span class='line'>  description THECOMPANY
</span><span class='line'>  vrf forwarding 100:THECOMPANY (matches VRF definition)
</span><span class='line'>  ip address x.x.x.x x.x.x.x (lives inside VRF)
</span><span class='line'>  no shutdown</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p><strong>Verify:</strong></p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>show ip interface brief
</span><span class='line'>show vrf
</span><span class='line'>show ip route vrf 100:THECOMPANY</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<h3>Routing Between CE and PE:</h3>

<p><img class="center" src="/images/blog_posts/mpls_vrf_forwarding_procedure.png"></p>

<ul>
<li>Routing needs to be configured and associated to VRF (PE routers ONLY)</li>
<li>CE routing needs to be configured (CE routers ONLY)</li>
<li>Mutual redistribution IGP&lt;&mdash;>mBGP needs to be configured (PE routers ONLY)</li>
</ul>


<p><strong>OSPF (PE):</strong></p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>router ospf 100 vrf 100:YOURCOMPANY
</span><span class='line'>  network x.x.x.x x.x.x.x area 0&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>show ip route vrf 100:YOURCOMPANY</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p><strong>OSPF (CE):</strong></p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>router ospf 1
</span><span class='line'>  network x.x.x.x x.x.x.x area 0</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p><strong>EIGRP (PE):</strong></p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>router eigrp 1
</span><span class='line'>  address-family ipv4 vrf 100:YOURCOMPANY autonomous-system 100
</span><span class='line'>  network x.x.x.x&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>show ip route vrf 100:YOURCOMPANY</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p><strong>EIGRP (CE):</strong></p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>router eigrp 1
</span><span class='line'>  network x.x.x.x
</span><span class='line'>  no auto-summary</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p><strong>RIP (PE):</strong></p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>router rip
</span><span class='line'>  version 2
</span><span class='line'>  address-family ipv4 vrf 100:YOURCOMPANY&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;pre>&lt;code>network x.x.x.x
</span><span class='line'>no auto-summary
</span><span class='line'>&lt;/code>&lt;/pre>
</span><span class='line'>
</span><span class='line'>&lt;p>show ip route vrf 100:YOURCOMPANY</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p><strong>RIP (CE):</strong></p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>router rip
</span><span class='line'>  version 2
</span><span class='line'>  network x.x.x.x
</span><span class='line'>  no auto-summary</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p><strong>BGP (PE):</strong></p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>router bgp 100
</span><span class='line'>  address-family ipv4 vrf 100:YOURCOMPANY&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;pre>&lt;code>neighbor x.x.x.x remote-as 101 (eBGP)
</span><span class='line'>exit
</span><span class='line'>&lt;/code>&lt;/pre>
</span><span class='line'>
</span><span class='line'>&lt;p>  address-family ipv4&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;pre>&lt;code>neighbor x.x.x.x next-hop-self
</span><span class='line'>&lt;/code>&lt;/pre>
</span><span class='line'>
</span><span class='line'>&lt;p>clear ip bgp x.x.x.x
</span><span class='line'>show ip route vrf 100:YOURCOMPANY</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p><strong>BGP (CE):</strong></p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>router bgp 101
</span><span class='line'>  neighbor x.x.x.x remote-as 100 (eBGP)
</span><span class='line'>  network x.x.x.x</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<h3>Redistribution on PE routers:</h3>

<ul>
<li>CE routes to be <strong>imported</strong> into VRF and <strong>exported</strong> to mBGP</li>
<li><strong>VPNv4 labels</strong> will be added to <strong>Label Switched Path (LSP)</strong> (Bottom Label).</li>
<li><strong>Route distinguiser (RD)</strong> and Route <strong>Target (RT)</strong> will be attached to routes.</li>
</ul>


<p><strong>OSPF mutual redistribution:</strong></p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>router bgp 100
</span><span class='line'>  address-family ipv4 vrf 100:YOURCOMPANY&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;pre>&lt;code>redistribute ospf 100 vrf 100:YOURCOMPANY
</span><span class='line'>exit
</span><span class='line'>&lt;/code>&lt;/pre>
</span><span class='line'>
</span><span class='line'>&lt;p>  exit&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>router ospf 100 vrf 100:YOURCOMPANY
</span><span class='line'>  redistribute bgp 100 subnets</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p><strong>EIGRP mutual redistribution:</strong></p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>router bgp 100
</span><span class='line'>  address-family ipv4 vrf 100:YOURCOMPANY&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;pre>&lt;code>redistribute eigrp 1
</span><span class='line'>exit
</span><span class='line'>&lt;/code>&lt;/pre>
</span><span class='line'>
</span><span class='line'>&lt;p>  exit&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>router eigrp 1
</span><span class='line'>  address-family ipv4 vrf 100:YOURCOMPANY autonomous-system 100&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;pre>&lt;code>redistribute bgp 100 metric y y y y y
</span><span class='line'>&lt;/code>&lt;/pre>
</span><span class='line'>
</span><span class='line'>&lt;p></span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p><strong>RIP mutual redistribution:</strong></p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>router bgp 100
</span><span class='line'>  address-family ipv4 vrf 100:YOURCOMPANY&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;pre>&lt;code>redistribute rip
</span><span class='line'>exit
</span><span class='line'>&lt;/code>&lt;/pre>
</span><span class='line'>
</span><span class='line'>&lt;p>  exit&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>router rip
</span><span class='line'>  address-family ipv4 vrf 100:YOURCOMPANY&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;pre>&lt;code>redistribute bgp 100 metric y (hop count)
</span><span class='line'>&lt;/code>&lt;/pre>
</span><span class='line'>
</span><span class='line'>&lt;p></span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p><strong>Verify:</strong></p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>show bgp vpnv4 unicast rd 100:1 labels
</span><span class='line'>show bgp vpnv4 unicast vrf 100:YOURCOMPANY label
</span><span class='line'>show mpls forwarding-table vrf 100:YOURCOMPANY
</span><span class='line'>show ip cef vrf 100:YOURCOMPANY x.x.x.x/xx
</span><span class='line'>show bgp vpnv4 unicast vrf 100:YOURCOMPANY x.x.x.x/xx
</span><span class='line'>show ip protocols
</span><span class='line'>traceroute x.x.x.x
</span><span class='line'>traceroute mpls ipv4 x.x.x.x x.x.x.x</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p><strong>Using &ldquo;VRF-aware&rdquo; applications for troubleshooting:</strong></p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>show ip route vrf 100:YOURCOMPANY
</span><span class='line'>ip route vrf 100:YOURCOMPANY x.x.x.x y.y.y.y z.z.z.z
</span><span class='line'>ping vrf 100:YOURCOMPANY x.x.x.x
</span><span class='line'>traceroute vrf 100:YOURCOMPANY x.x.x.x
</span><span class='line'>telnet x.x.x.x /vrf 100:YOURCOMPANY</span></code></pre></td></tr></table></div></figure></notextile></div></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[BGP Basics and Best Path Selection - part1]]></title>
    <link href="http://devrandom.za.net/blog/2014/12/17/bgp-basics-and-best-path-selection/"/>
    <updated>2014-12-17T21:26:20+02:00</updated>
    <id>http://devrandom.za.net/blog/2014/12/17/bgp-basics-and-best-path-selection</id>
    <content type="html"><![CDATA[<p><img class="left" src="/images/blog_posts/bgp.png"></p>

<p>This is part 1 of 4. My shortish summarized version of Cisco BGP Basics and Best Path Selection.</p>

<!--more-->


<br>


<br>


<br>


<br>


<br>


<p><iframe width="640" height="360" src="http://www.youtube.com/embed/z8INzy9E628 " frameborder="0" allowfullscreen></iframe></p>

<h3>BGP Rules:</h3>

<ul>
<li>Path Vector protocol that routes AS to AS (AS-Path).</li>
<li>&ldquo;You CAN&rsquo;T tell someone else what to do whith their traffic!&rdquo;</li>
<li>Use TCP port 179 to establish neighbor relationships.</li>
<li>Private AS range = 64512 &ndash; 65535</li>
<li>By default ONLY advertise best path.</li>
<li>Triggered updates ONLY (default 5 seconds INTERNAL and 30 seconds EXTERNAL).</li>
<li>Neighbor relationships form/converge in approximately 30 &ndash; 60 seconds (SLOW)</li>
<li>Default Hold timers: 180 seconds.</li>
<li>Loopback routes get default weight of 32768.</li>
<li><code>network x.x.x.x</code> must be EXACT match as in routing table otherwise BGP will not advertise it.</li>
<li>iBGP does NOT modify any attributes like AS-Path or Next-hop, therefore has rules like split-horizon to prevent loops. (<code>neighbor x.x.x.x next-hop-self</code>).</li>
<li>iBGP, use <strong>loopbacks</strong> to form neighbor relationships.</li>
<li>By default sends BGP messages to eBGP neighbors with a TTL of 1</li>
<li>Supports up to 6 paths load-balanced.</li>
<li>If BGP <code>synchronization</code> enabled, there must be a match for the prefix in the IP routing table to be considered valid path.</li>
</ul>


<h3>Best Path Algorithm:</h3>

<ol>
<li>MOST specific route</li>
<li>Administrative distance</li>
</ol>


<table>
<thead>
<tr>
<th align="left"></th>
<th align="center">“We Love Oranges AS Oranges Mean Pure Refreshment”</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">W       </td>
<td align="center">Weight (Highest)</td>
</tr>
<tr>
<td align="left">L       </td>
<td align="center">LOCAL_PREF (Highest)</td>
</tr>
<tr>
<td align="left">O       </td>
<td align="center">Originate (local)</td>
</tr>
<tr>
<td align="left">AS      </td>
<td align="center">AS_PATH (shortest)</td>
</tr>
<tr>
<td align="left">O       </td>
<td align="center">ORIGIN Code (IGP > EGP > Incomplete)</td>
</tr>
<tr>
<td align="left">M       </td>
<td align="center">MED (lowest)</td>
</tr>
<tr>
<td align="left">P       </td>
<td align="center">Paths (External > Internal)</td>
</tr>
<tr>
<td align="left">R       </td>
<td align="center">RID (lowest)</td>
</tr>
</tbody>
</table>


<h3>Basic Config:</h3>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>neighbor x.x.x.x remote-as &lt;AS_NUM>
</span><span class='line'>neighbor x.x.x.x update-source loopback0
</span><span class='line'>neighbor x.x.x.x description &lt;WHATEVER>
</span><span class='line'>no synchronization
</span><span class='line'>no auto-summary</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<h3>Basic Show Commands:</h3>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>show ip bgp summary
</span><span class='line'>show ip bgp</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p><strong>NOTES:</strong></p>

<p>If eBGP neighbor is NOT directly connected (iBGP does NOT use same rules):
<code>neighbor x.x.x.x ebgp-multihop &lt;HOP_COUNT_1-255&gt;</code></p>

<p>Removing <strong>private AS</strong> number outbound:
<code>neighbor x.x.x.x remove-private-as</code></p>

<p>Authentication: (MUST match both sides of neighbor relationship)</p>

<ul>
<li><code>neighbor x.x.x.x password 0 cisco</code> (clear text)</li>
<li><code>neighbor x.x.x.x password 7 DFEAF10390E560AEA745CCBA53E044ED</code> (MD5 hashed)</li>
</ul>


<p>Advertise default route outbound:
<code>neighbor x.x.x.x default-originate</code></p>
]]></content>
  </entry>
  
</feed>
