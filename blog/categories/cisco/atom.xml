<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: cisco | Random Notes]]></title>
  <link href="http://devrandom.za.net/blog/categories/cisco/atom.xml" rel="self"/>
  <link href="http://devrandom.za.net/"/>
  <updated>2014-12-22T23:16:21+02:00</updated>
  <id>http://devrandom.za.net/</id>
  <author>
    <name><![CDATA[S.J. Louw]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[MPLS Layer 3 VPN Basics, Setup and Verification - part1]]></title>
    <link href="http://devrandom.za.net/blog/2014/12/22/mpls-layer-3-vpn-basics-setup-and-verification/"/>
    <updated>2014-12-22T22:59:29+02:00</updated>
    <id>http://devrandom.za.net/blog/2014/12/22/mpls-layer-3-vpn-basics-setup-and-verification</id>
    <content type="html"><![CDATA[<p><img class="left" src="/images/blog_posts/mpls.png"></p>

<p>This is part 1 of 2. My shortish summarized version of MPLS Layer 3 VPN Basics, Setup and Verification.</p>

<!--more-->


<br>


<br>


<br>


<br>


<br>


<p><iframe width="640" height="360" src="http://www.youtube.com/embed/MEWIdO40U54 " frameborder="0" allowfullscreen></iframe></p>

<h3>MPLS Layer 3 VPNs:</h3>

<ul>
<li>Private routing (site-2-site) per customer (VRF)</li>
<li>Virtual Network (private) VPN &ndash; Separates data-plane, securely (NO encryption), per customer.</li>
<li>Terminology:

<ul>
<li>Label Switched Path (<strong>LSP</strong>)</li>
<li>Label Switch Router (<strong>LSR</strong>)</li>
<li>Customer Edge (<strong>CE</strong>)</li>
<li>Provider Edge (<strong>PE</strong>)</li>
<li>Provider (<strong>P</strong>)</li>
<li>Routing Information Base (<strong>RIB</strong>)</li>
<li>Forwarding Information Base (<strong>FIB</strong>)</li>
<li>Label Information Base (<strong>LIB</strong>)</li>
<li>Label Forwarding Information Base (<strong>LFIB</strong>)</li>
</ul>
</li>
<li>General label flow procedure:

<ul>
<li>CE &mdash;&mdash;&mdash;&mdash;&mdash;&mdash;> PE = <strong>PUSH</strong> label (entering core)</li>
<li>PE &mdash;&mdash;&mdash;&mdash;&mdash;&mdash;> PE = <strong>SWOP</strong> labels (inside core)</li>
<li>PE &mdash;&mdash;&mdash;&mdash;&mdash;&mdash;> CE = <strong>POP</strong> label (exiting core)</li>
</ul>
</li>
<li>MPLSs' control-plane protocol is Label Distribution Protocol <strong>(LDP)</strong></li>
<li>Experimental bits inside packet = Used for QoS</li>
<li>Bottom-of-stack bits (S-bit) inside packet = If = 1 indicates bottom of stack has been reached</li>
<li>MPLS header injected between Data-link (Layer2) and Network layer (Layer3)</li>
</ul>


<h3>Basic Setup Procedure:</h3>

<ol>
<li>Before setting up MPLS, first verify basic IP routing/reachability.</li>
<li>Setup MPLS only on PE to PE routers.</li>
<li><code>mpls label range 100 199</code> (Setup label range for router to use)</li>
<li><code>mpls ip</code> (Enable MPLS in Global Config mode)</li>
<li><code>mpls ip</code> (Enable MPLS under interfaces to be used)</li>
</ol>


<p>When MPLS is enabled globally, it creates local labels for each route in it&rsquo;s routing table. (default does <strong>NOT</strong> stay static, can change) Then when MPLS is enabled on interfaces, <strong>LDP</strong> forms neighbors and exchange labels.</p>

<h3>Verifying Labels:</h3>

<ol>
<li><code>show mpls ldp bindings x.x.x.x &lt;SLASH_NOTATION_MASK&gt;</code></li>
<li><code>show mpls forwarding-table x.x.x.x</code> (Forwarding table is build from <strong>RIB</strong>)</li>
</ol>


<p><strong>NOTES:</strong></p>

<ul>
<li>Label, implicit Null (<strong>imp-null</strong>) (3) &ndash; Directly attached networks</li>
<li>MPLS reserved labels = 0-15</li>
<li>By default LAST <strong>P</strong> router POPs label before sending to LAST <strong>PE</strong> router. (Penultimate Hop Popping &ndash; PHP)</li>
<li>If MPLS enabled : <code>traceroute</code> will include MPLS label</li>
</ul>


<h3>Label Distribution Protocol (LDP):</h3>

<ul>
<li>Labels does <strong>NOT</strong> stay statically numbered by default. It <strong>WILL</strong> change when router reboots, config changes, etc.</li>
<li>Best path will ALWAYS be LSP over IPv4</li>
<li>IPv4 <strong>transport address</strong> (can be changed) used to form neighbors, NOT necessarily = Router-ID.</li>
<li>Router MUST be able to reach neighbor&rsquo;s <strong>transport address</strong> to establish neighbor relationship.</li>
<li>Use multicast <strong>224.0.0.2</strong>, destination <strong>UDP port 646</strong> in Hello packets.</li>
<li>Use unicast, <strong>TCP port 646</strong> to establish neighbor relationship.</li>
<li>Highest Router-ID will be <strong>Active / initiating</strong> router and lower Router-ID will be <strong>Passive / receiving</strong> router in TCP LDP neighbor negotiation.</li>
</ul>


<p>Show labels assigned to routes:</p>

<p><code>show mpls ldp binings</code></p>

<p>Show local labels ONLY:</p>

<p><code>show mpls ldp bindings local</code></p>

<p>Show label best path for a route:</p>

<p><code>show mpls forwarding-table x.x.x.x</code></p>

<p>Debug LDP bindings:</p>

<p><code>debug mpls ldp bindings</code></p>

<p><strong>LDP Router-ID selection, order of preference:</strong></p>

<ol>
<li>Administratively configured address (<code>mpls ldp router-id &lt;INTERFACE/NUM&gt; force (global config mode)</code>)</li>
<li>Highest IP address on loopback</li>
<li>Highest IP address on interface</li>
</ol>


<p><strong>Transport address selection, order of preference:</strong></p>

<ol>
<li>Administratively configured address (<code>mpls ldp discovery transport-address interface (under interface)</code>)</li>
<li>Router-ID</li>
</ol>


<p><strong>Verifying both Router-ID and transport address:</strong></p>

<p><code>show mpls ldp discovery detail</code></p>

<h3>Label Switched Path (LSP):</h3>

<p><strong>Label Retention:</strong></p>

<ul>
<li><strong>Liberal Label Retention (LLR) (default):</strong> Label mapping received from peer is retained regardless of whether the LSR is the next hop for advertised mapping.</li>
<li><strong>Conservative Label retention (CLR):</strong> Label mappings will ONLY be retained if sending LSR is next hop downstream router for this specific FEC. ONLY labels used for MPLS packet forwarding are kept in LIB.</li>
</ul>


<p><strong>Verification:</strong></p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>show mpls ldp neighbor
</span><span class='line'>show mpls ldp bindings x.x.x.x
</span><span class='line'>show mpls forwarding-table x.x.x.x
</span><span class='line'>traceroute x.x.x.x</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<h3>Multi-protocol BGP (mBGP):</h3>

<ul>
<li>Configured on PE routers</li>
<li>VPNv4 routes include VRF/Route distinguishing (RD) info</li>
<li><strong>Route targets</strong> included inside VPNv4 routes as extended community values, to be imported into VRFs on PE routers.</li>
</ul>


<p><strong>Configuration:</strong></p>

<p><strong>1. Verify</strong> PE to PE connectivity (<code>ping</code> / <code>traceroute</code>)</p>

<p><strong>2. Setup:</strong>
<div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>router bgp 100
</span><span class='line'>  neighbor x.x.x.x remote-as 100 (iBGP)
</span><span class='line'>  neighbor x.x.x.x update-source loopback 0
</span><span class='line'>  address-family vpnv4&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;pre>&lt;code>neighbor x.x.x.x activate
</span><span class='line'>neighbor x.x.x.x send-community extended
</span><span class='line'>&lt;/code>&lt;/pre>
</span><span class='line'>
</span><span class='line'>&lt;p></span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p><strong>3. Verify:</strong>
<div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>show ip bgp neighbors | section capabilities
</span><span class='line'>show control-plane host open-ports</span></code></pre></td></tr></table></div></figure></notextile></div></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[MPLS Layer 3 VPN VRFs and Redistribution - part2]]></title>
    <link href="http://devrandom.za.net/blog/2014/12/21/mpls-layer-3-vpn-vrfs-and-redistribution/"/>
    <updated>2014-12-21T14:16:06+02:00</updated>
    <id>http://devrandom.za.net/blog/2014/12/21/mpls-layer-3-vpn-vrfs-and-redistribution</id>
    <content type="html"><![CDATA[<p><img class="left" src="/images/blog_posts/mpls.png"></p>

<p>This is part 2 of 2. My shortish summarized version of MPLS Layer 3 VPN VRFs and Redistribution.</p>

<!--more-->


<br>


<br>


<br>


<br>


<h3>Virtual Routing and Forwarding (VRF) Instances:</h3>

<ul>
<li><strong>VRF Name:</strong> AS:THECOMPANY</li>
<li><strong>Route Distinguisher:</strong> AS:NUMBER or IP_ADDRESS:NUMBER (Does NOT have to match PE-PE)</li>
<li><strong>Route Target (extended community):</strong> IP_ADDRESS:NUMBER or AS:NUMBER (Export and Import MUST match PE-PE)</li>
<li><strong>Interface</strong> towards CE to be allocated to VRF</li>
</ul>


<p>NOTES:</p>

<p>In production, disable TTL propagation (on <strong>ALL</strong> MPLS routers) to hide label info inside traceroute! (<code>no mpls ip propagate-ttl</code>)</p>

<p><strong>Configuration (On PE routers):</strong></p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>vrf definition 100:THECOMPANY
</span><span class='line'>  rd 100:1
</span><span class='line'>  address-family ipv4&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;pre>&lt;code>route-target export x.x.x.x:100 (reversed on other PE router)
</span><span class='line'>route-target import y.y.y.y:100 (reversed on other PE router)
</span><span class='line'>exit
</span><span class='line'>&lt;/code>&lt;/pre>
</span><span class='line'>
</span><span class='line'>&lt;p>  exit&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>interface Gi0/1
</span><span class='line'>  description THECOMPANY
</span><span class='line'>  vrf forwarding 100:THECOMPANY (matches VRF definition)
</span><span class='line'>  ip address x.x.x.x x.x.x.x (lives inside VRF)
</span><span class='line'>  no shutdown</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p><strong>Verify:</strong></p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>show ip interface brief
</span><span class='line'>show vrf
</span><span class='line'>show ip route vrf 100:THECOMPANY</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<h3>Routing Between CE and PE:</h3>

<p><img class="center" src="/images/blog_posts/mpls_vrf_forwarding_procedure.png"></p>

<ul>
<li>Routing needs to be configured and associated to VRF (PE routers ONLY)</li>
<li>CE routing needs to be configured (CE routers ONLY)</li>
<li>Mutual redistribution IGP&lt;&mdash;>mBGP needs to be configured (PE routers ONLY)</li>
</ul>


<p><strong>OSPF (PE):</strong></p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>router ospf 100 vrf 100:YOURCOMPANY
</span><span class='line'>  network x.x.x.x x.x.x.x area 0&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>show ip route vrf 100:YOURCOMPANY</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p><strong>OSPF (CE):</strong></p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>router ospf 1
</span><span class='line'>  network x.x.x.x x.x.x.x area 0</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p><strong>EIGRP (PE):</strong></p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>router eigrp 1
</span><span class='line'>  address-family ipv4 vrf 100:YOURCOMPANY autonomous-system 100
</span><span class='line'>  network x.x.x.x&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>show ip route vrf 100:YOURCOMPANY</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p><strong>EIGRP (CE):</strong></p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>router eigrp 1
</span><span class='line'>  network x.x.x.x
</span><span class='line'>  no auto-summary</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p><strong>RIP (PE):</strong></p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>router rip
</span><span class='line'>  version 2
</span><span class='line'>  address-family ipv4 vrf 100:YOURCOMPANY&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;pre>&lt;code>network x.x.x.x
</span><span class='line'>no auto-summary
</span><span class='line'>&lt;/code>&lt;/pre>
</span><span class='line'>
</span><span class='line'>&lt;p>show ip route vrf 100:YOURCOMPANY</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p><strong>RIP (CE):</strong></p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>router rip
</span><span class='line'>  version 2
</span><span class='line'>  network x.x.x.x
</span><span class='line'>  no auto-summary</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p><strong>BGP (PE):</strong></p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>router bgp 100
</span><span class='line'>  address-family ipv4 vrf 100:YOURCOMPANY&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;pre>&lt;code>neighbor x.x.x.x remote-as 101 (eBGP)
</span><span class='line'>exit
</span><span class='line'>&lt;/code>&lt;/pre>
</span><span class='line'>
</span><span class='line'>&lt;p>  address-family ipv4&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;pre>&lt;code>neighbor x.x.x.x next-hop-self
</span><span class='line'>&lt;/code>&lt;/pre>
</span><span class='line'>
</span><span class='line'>&lt;p>clear ip bgp x.x.x.x
</span><span class='line'>show ip route vrf 100:YOURCOMPANY</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p><strong>BGP (CE):</strong></p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>router bgp 101
</span><span class='line'>  neighbor x.x.x.x remote-as 100 (eBGP)
</span><span class='line'>  network x.x.x.x</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<h3>Redistribution on PE routers:</h3>

<ul>
<li>CE routes to be <strong>imported</strong> into VRF and <strong>exported</strong> to mBGP</li>
<li><strong>VPNv4 labels</strong> will be added to <strong>Label Switched Path (LSP)</strong> (Bottom Label).</li>
<li><strong>Route distinguiser (RD)</strong> and Route <strong>Target (RT)</strong> will be attached to routes.</li>
</ul>


<p><strong>OSPF mutual redistribution:</strong></p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>router bgp 100
</span><span class='line'>  address-family ipv4 vrf 100:YOURCOMPANY&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;pre>&lt;code>redistribute ospf 100 vrf 100:YOURCOMPANY
</span><span class='line'>exit
</span><span class='line'>&lt;/code>&lt;/pre>
</span><span class='line'>
</span><span class='line'>&lt;p>  exit&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>router ospf 100 vrf 100:YOURCOMPANY
</span><span class='line'>  redistribute bgp 100 subnets</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p><strong>EIGRP mutual redistribution:</strong></p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>router bgp 100
</span><span class='line'>  address-family ipv4 vrf 100:YOURCOMPANY&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;pre>&lt;code>redistribute eigrp 1
</span><span class='line'>exit
</span><span class='line'>&lt;/code>&lt;/pre>
</span><span class='line'>
</span><span class='line'>&lt;p>  exit&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>router eigrp 1
</span><span class='line'>  address-family ipv4 vrf 100:YOURCOMPANY autonomous-system 100&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;pre>&lt;code>redistribute bgp 100 metric y y y y y
</span><span class='line'>&lt;/code>&lt;/pre>
</span><span class='line'>
</span><span class='line'>&lt;p></span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p><strong>RIP mutual redistribution:</strong></p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>router bgp 100
</span><span class='line'>  address-family ipv4 vrf 100:YOURCOMPANY&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;pre>&lt;code>redistribute rip
</span><span class='line'>exit
</span><span class='line'>&lt;/code>&lt;/pre>
</span><span class='line'>
</span><span class='line'>&lt;p>  exit&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>router rip
</span><span class='line'>  address-family ipv4 vrf 100:YOURCOMPANY&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;pre>&lt;code>redistribute bgp 100 metric y (hop count)
</span><span class='line'>&lt;/code>&lt;/pre>
</span><span class='line'>
</span><span class='line'>&lt;p></span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p><strong>Verify:</strong></p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>show bgp vpnv4 unicast rd 100:1 labels
</span><span class='line'>show bgp vpnv4 unicast vrf 100:YOURCOMPANY label
</span><span class='line'>show mpls forwarding-table vrf 100:YOURCOMPANY
</span><span class='line'>show ip cef vrf 100:YOURCOMPANY x.x.x.x/xx
</span><span class='line'>show bgp vpnv4 unicast vrf 100:YOURCOMPANY x.x.x.x/xx
</span><span class='line'>show ip protocols
</span><span class='line'>traceroute x.x.x.x
</span><span class='line'>traceroute mpls ipv4 x.x.x.x x.x.x.x</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p><strong>Using &ldquo;VRF-aware&rdquo; applications for troubleshooting:</strong></p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>show ip route vrf 100:YOURCOMPANY
</span><span class='line'>ip route vrf 100:YOURCOMPANY x.x.x.x y.y.y.y z.z.z.z
</span><span class='line'>ping vrf 100:YOURCOMPANY x.x.x.x
</span><span class='line'>traceroute vrf 100:YOURCOMPANY x.x.x.x
</span><span class='line'>telnet x.x.x.x /vrf 100:YOURCOMPANY</span></code></pre></td></tr></table></div></figure></notextile></div></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[BGP Basics and Best Path Selection - part1]]></title>
    <link href="http://devrandom.za.net/blog/2014/12/17/bgp-basics-and-best-path-selection/"/>
    <updated>2014-12-17T21:26:20+02:00</updated>
    <id>http://devrandom.za.net/blog/2014/12/17/bgp-basics-and-best-path-selection</id>
    <content type="html"><![CDATA[<p><img class="left" src="/images/blog_posts/bgp.png"></p>

<p>This is part 1 of 4. My shortish summarized version of Cisco BGP Basics and Best Path Selection.</p>

<!--more-->


<br>


<br>


<br>


<br>


<br>


<p><iframe width="640" height="360" src="http://www.youtube.com/embed/z8INzy9E628 " frameborder="0" allowfullscreen></iframe></p>

<h3>BGP Rules:</h3>

<ul>
<li>Path Vector protocol that routes AS to AS (AS-Path).</li>
<li>&ldquo;You CAN&rsquo;T tell someone else what to do whith their traffic!&rdquo;</li>
<li>Use TCP port 179 to establish neighbor relationships.</li>
<li>Private AS range = 64512 &ndash; 65535</li>
<li>By default ONLY advertise best path.</li>
<li>Triggered updates ONLY (default 5 seconds INTERNAL and 30 seconds EXTERNAL).</li>
<li>Neighbor relationships form/converge in approximately 30 &ndash; 60 seconds (SLOW)</li>
<li>Default Hold timers: 180 seconds.</li>
<li>Loopback routes get default wight of 32768.</li>
<li><code>network x.x.x.x</code> must be EXACT match as in routing table otherwise BGP will not advertise it.</li>
<li>iBGP does NOT modify any attributes like AS-Path or Next-hop, therefore has rules like split-horizon to prevent loops. (<code>neighbor x.x.x.x next-hop-self</code>).</li>
<li>iBGP, use <strong>loopbacks</strong> to form neighbor relationships.</li>
<li>By default sends BGP messages to eBGP neighbors with a TTL of 1</li>
<li>Supports up to 6 paths load-balanced.</li>
</ul>


<h3>Best Path Algorithm:</h3>

<ol>
<li>MOST specific route</li>
<li>Administrative distance</li>
</ol>


<table>
<thead>
<tr>
<th align="left"></th>
<th align="center">“We Love Oranges AS Oranges Mean Pure Refreshment”</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">W       </td>
<td align="center">Weight (Highest)</td>
</tr>
<tr>
<td align="left">L       </td>
<td align="center">LOCAL_PREF (Highest)</td>
</tr>
<tr>
<td align="left">O       </td>
<td align="center">Originate (local)</td>
</tr>
<tr>
<td align="left">AS      </td>
<td align="center">AS_PATH (shortest)</td>
</tr>
<tr>
<td align="left">O       </td>
<td align="center">ORIGIN Code (IGP > EGP > Incomplete)</td>
</tr>
<tr>
<td align="left">M       </td>
<td align="center">MED (lowest)</td>
</tr>
<tr>
<td align="left">P       </td>
<td align="center">Paths (External > Internal)</td>
</tr>
<tr>
<td align="left">R       </td>
<td align="center">RID (lowest)</td>
</tr>
</tbody>
</table>


<h3>Basic Config:</h3>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>neighbor x.x.x.x remote-as &lt;AS_NUM>
</span><span class='line'>neighbor x.x.x.x update-source loopback0
</span><span class='line'>neighbor x.x.x.x description &lt;WHATEVER>
</span><span class='line'>no synchronization
</span><span class='line'>no auto-summary</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<h3>Basic Show Commands:</h3>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>show ip bgp summary
</span><span class='line'>show ip bgp</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p><strong>NOTES:</strong></p>

<p>If eBGP neighbor is NOT directly connected (iBGP does NOT use same rules):
<code>neighbor x.x.x.x ebgp-multihop &lt;HOP_COUNT_1-255&gt;</code></p>

<p>Removing <strong>private AS</strong> number outbound:
<code>neighbor x.x.x.x remove-private-as</code></p>

<p>Authentication: (MUST match both sides of neighbor relationship)</p>

<ul>
<li><code>neighbor x.x.x.x password 0 cisco</code> (clear text)</li>
<li><code>neighbor x.x.x.x password 7 DFEAF10390E560AEA745CCBA53E044ED</code> (MD5 hashed)</li>
</ul>


<p>Advertise default route outbound:
<code>neighbor x.x.x.x default-originate</code></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[BGP Filters and Communities - part2]]></title>
    <link href="http://devrandom.za.net/blog/2014/12/17/bgp-filters-and-communities/"/>
    <updated>2014-12-17T21:25:55+02:00</updated>
    <id>http://devrandom.za.net/blog/2014/12/17/bgp-filters-and-communities</id>
    <content type="html"><![CDATA[<p><img class="left" src="/images/blog_posts/bgp.png"></p>

<p>This is part 2 of 4. My shortish summarized version of Cisco BGP Filters and Communities.</p>

<!--more-->


<br>


<br>


<br>


<br>


<br>


<table>
<thead>
<tr>
<th align="left">MATCH USING&hellip;     </th>
<th align="left">STUFF TO SET&hellip;       </th>
<th align="left">DIRECTION</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">prefix-list         </td>
<td align="left">weight               </td>
<td align="left">inbound</td>
</tr>
<tr>
<td align="left">access-list         </td>
<td align="left">local preference     </td>
<td align="left">outbound</td>
</tr>
<tr>
<td align="left">as-path access-list </td>
<td align="left">origin               </td>
<td></td>
</tr>
<tr>
<td align="left">neighbor            </td>
<td align="left">as-path (prepending) </td>
<td></td>
</tr>
<tr>
<td align="left">route-map           </td>
<td align="left">med/metric           </td>
<td></td>
</tr>
<tr>
<td align="left">community-list      </td>
<td align="left">next-hop (self)      </td>
<td></td>
</tr>
<tr>
<td align="left">distribute-list     </td>
<td align="left">community            </td>
<td></td>
</tr>
<tr>
<td align="left">filter-list         </td>
<td align="left">                     </td>
<td></td>
</tr>
<tr>
<td align="left">&hellip;and lots more    </td>
<td align="left">&hellip;and lots more     </td>
<td></td>
</tr>
</tbody>
</table>


<h3>REGEX Filters:</h3>

<p>Example: Filter AS 100 outbound with REGEX</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ip as-path access-list 1 deny &lt;REGEX> (&lt;code>_100_&lt;/code>) (Match AS 100 exactly)
</span><span class='line'>ip as-path access-list 1 permit &lt;REGEX> (&lt;code>.*&lt;/code>) (Match all/permit any)&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>route-map FILTER_100 permit 10
</span><span class='line'>  match as-path 1&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>router bgp &lt;AS_NUM> (100)
</span><span class='line'>  neighbor x.x.x.x route-map FILTER_100 out&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>clear ip bgp x.x.x.x</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<h3>Prefix-lists:</h3>

<p>Prefix-lists is for matching routes!</p>

<ul>
<li>Uses tree-structure</li>
<li>Better CPU utilization</li>
<li>Better subnet matching</li>
<li>Two-stage matching system: <strong>network + mask</strong></li>
<li>Created in <strong>Global Config</strong> mode</li>
<li>Matches x.x.x.x/xx EXACTLY</li>
<li><strong>le</strong> = less than or equel</li>
<li><strong>ge</strong> = greater than or equel</li>
</ul>


<p><strong>Examples:</strong></p>

<ol>
<li><code>ip prefix-list NAME permit 0.0.0.0/0</code> matches ONLY 0.0.0.0/0 (default route)</li>
<li><code>ip prefix-list NAME permit 0.0.0.0/0 ge 32</code> matches all HOST routes</li>
<li><code>ip prefix-list NAME permit 0.0.0.0/0 le 32</code> matches ANY route</li>
<li><code>ip prefix-list NAME permit 0.0.0.0/1 ge 24 le 24</code> matches CLASS A networks or it&rsquo;s subnets</li>
<li><code>ip prefix-list NAME permit 128.0.0.0/2 ge 16</code> matches CLASS B networks or it&rsquo;s subnets</li>
</ol>


<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ip prefix-list NAME permit 0.0.0.0/0 ge 32&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>router bgp 100
</span><span class='line'>  neighbor x.x.x.x prefix-list NAME in&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>clear ip bgp x.x.x.x</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>Prefix-lists can also be attached to route-maps.</p>

<h3>Outbound Route Filtering (ORF):</h3>

<ul>
<li>Transmits INBOUND filters to apply OUTBOUND</li>
<li>Neighbors must support <strong>ORF Type</strong> both sides</li>
<li><code>neighbor x.x.x.x capability orf prefix-list &lt;SEND_RECEIVE_BOTH&gt;</code></li>
</ul>


<h3>BGP Communities:</h3>

<ul>
<li>The BGP community value is an optional, transitive attribute.</li>
<li>ISP&rsquo;s normally create community values for customers, to use, to influence routes.</li>
<li>RFC guideline format: 100:12345 where <strong>100 = AS_NUM</strong> and <strong>12345 = community value</strong></li>
<li>community-list <strong>(1-99)</strong> matches on normal community values</li>
<li>community-list <strong>(100-199)</strong> matches on REGEX</li>
</ul>


<p><strong>By default 4 well known communities that can be used to mark prefixes:</strong></p>

<ul>
<li><strong>Internet:</strong> advertise these routes to all neighbors.</li>
<li><strong>Local-as:</strong> prevent sending routes outside the local As within the confederation.</li>
<li><strong>No-Advertise:</strong> do not advertise this route to any peer, internal or external.</li>
<li><strong>No-Export:</strong> do not advertise this route to external BGP peers.</li>
</ul>


<p><strong>Examples:</strong></p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ip bgp-community new-format
</span><span class='line'>  neighbor x.x.x.x send-community&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>ip access-list standard CUSTOMER_ROUTES
</span><span class='line'>  permit x.x.x.x x.x.x.x&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>route-map SET-COMMUNITY
</span><span class='line'>  match ip address CUSTOMER_ROUTES
</span><span class='line'>  set community 100:12345 100:84957 100:3892 (Multiple can be added on one line)</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ip community-list 1 permit 100:2345&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>route-map MYMAP
</span><span class='line'>  match community 1
</span><span class='line'>  set local_preference 20</span></code></pre></td></tr></table></div></figure></notextile></div></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[BGP Route Reflectors and Confederations - part3]]></title>
    <link href="http://devrandom.za.net/blog/2014/12/17/bgp-route-reflectors-and-confederations/"/>
    <updated>2014-12-17T21:25:21+02:00</updated>
    <id>http://devrandom.za.net/blog/2014/12/17/bgp-route-reflectors-and-confederations</id>
    <content type="html"><![CDATA[<p><img class="left" src="/images/blog_posts/bgp.png"></p>

<p>This is part 3 of 4. My shortish summarized version of Cisco BGP Route Reflectors and Confederations.</p>

<!--more-->


<br>


<br>


<br>


<br>


<h3>Route Reflectors:</h3>

<p>iBGP MUST have full mesh to prevent loops, thus to scale, you can use Route Reflectors.</p>

<ol>
<li>Clients must have full mesh connection to Route-Reflectors.</li>
<li>Route Reflector groups add a cluster-id attribute to routes.</li>
</ol>


<p><strong>Route Reflectors process updates as follows:</strong></p>

<ul>
<li>Updates received from <strong>eBGP</strong> peers: Forward to all <strong>iBGP and eBGP</strong> peers.</li>
<li>Updates received from <strong>iBGP (non-client)</strong> peers: Forward to all <strong>eBGP and Client</strong> peers.</li>
<li>Updates received from <strong>iBGP (client)</strong> peers: Forward to <strong>all</strong> peers <strong>except sender</strong>.</li>
</ul>


<p>Example Route Reflector Client Setup (No client-side setup needed):</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>neighbor x.x.x.x route-reflector-client</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>Example Route Reflector Cluster Setup:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>router bgp 100
</span><span class='line'>  bgp cluster-id 10</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<h3>Confederations:</h3>

<p>Another way to solve the iBGP full mesh problem is to use Confederations.</p>

<ul>
<li>An AS inside an AS</li>
<li>Uses <strong>INTRA-AS</strong> numbers which are stripped before sending updates via eBGP.</li>
<li>Inter-Confederation peers are treated as eBGP to establish, but as iBGP relating to attributes.</li>
<li>Breaks iBGP AS into smaller Autonomous Systems.</li>
<li>Use private AS numbers (64512 &ndash; 65535)</li>
<li>Full iBGP mesh required <strong>within confederation AS</strong> (RR also an option within confederation)</li>
</ul>


<p>Example:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>router bgp 64512
</span><span class='line'>  bgp confederation identifier 500
</span><span class='line'>  bgp confederation peers 64513 64514
</span><span class='line'>  neighbor x.x.x.x remote-as 64512 (will be iBGP)
</span><span class='line'>  neighbor y.y.y.y remote-as 64513 (will be eBGP)
</span><span class='line'>  neighbor y.y.y.y ebgp-multihop &lt;HOP_COUNT>
</span><span class='line'>  neighbor z.z.z.z remote-as 64514 (will be eBGP)
</span><span class='line'>  neighbor z.z.z.z ebgp-multihop &lt;HOP_COUNT>&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>show ip bgp neighbors</span></code></pre></td></tr></table></div></figure></notextile></div></p>
]]></content>
  </entry>
  
</feed>
